<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMD Inventory Dashboard</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Chart.js for graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS for Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['Plus Jakarta Sans', 'sans-serif'],
      },
      colors: {
        brand: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          500: '#0ea5e9',
          600: '#0284c7',
          700: '#0369a1',
          900: '#0c4a6e',
        },
        accent: {
          500: '#6366f1',
          600: '#4f46e5',
        }
      },
      animation: {
        'fade-in': 'fadeIn 0.5s ease-out forwards',
        'slide-up': 'slideUp 0.4s ease-out forwards',
        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        'bounce-slow': 'bounce 2s infinite',
        'float': 'float 3s ease-in-out infinite',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        slideUp: {
          '0%': { opacity: '0', transform: 'translateY(20px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' },
        },
        float: {
          '0%, 100%': { transform: 'translateY(0px)' },
          '50%': { transform: 'translateY(-10px)' },
        }
      }
    }
  }
}
</script>
<style>
body {
  background-color: #f8fafc;
  background-image:
    radial-gradient(at 0% 0%, rgba(14, 165, 233, 0.15) 0px, transparent 50%),
    radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.15) 0px, transparent 50%);
  background-attachment: fixed;
}
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}
.glass {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.5);
}
.glass-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
}
.sidebar {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.modal-backdrop {
  background-color: rgba(15, 23, 42, 0.7);
  backdrop-filter: blur(8px);
}
.loader-ring {
  display: inline-block;
  width: 48px;
  height: 48px;
}
.loader-ring:after {
  content: " ";
  display: block;
  width: 40px;
  height: 40px;
  margin: 4px;
  border-radius: 50%;
  border: 4px solid #0ea5e9;
  border-color: #0ea5e9 transparent #0ea5e9 transparent;
  animation: loader-ring 1.2s linear infinite;
}
@keyframes loader-ring {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.nav-item.active {
  background: linear-gradient(90deg, rgba(14, 165, 233, 0.15) 0%, rgba(255,255,255,0) 100%);
  border-left: 3px solid #0ea5e9;
  color: #0369a1;
  font-weight: 600;
}
.nav-item.disabled {
  opacity: 0.4;
  pointer-events: none;
  cursor: not-allowed;
  filter: grayscale(100%);
}
.toggle-switch {
  position: relative;
  width: 50px;
  height: 26px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #e2e8f0;
  transition: .4s;
  border-radius: 34px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
input:checked + .toggle-slider {
  background-color: #0ea5e9;
}
input:checked + .toggle-slider:before {
  transform: translateX(24px);
}
.stock-alert {
  animation: pulse-alert 2s infinite;
}
@keyframes pulse-alert {
  0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
  50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
}
.login-card {
  background: linear-gradient(145deg, rgba(255,255,255,0.98) 0%, rgba(240,249,255,0.95) 100%);
  backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.8);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}
.avatar-upload {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
}
.avatar-upload:hover {
  transform: scale(1.05);
  box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
}
.avatar-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.avatar-upload .overlay {
  position: absolute;
  inset: 0;
  background: rgba(14, 165, 233, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.avatar-upload:hover .overlay {
  opacity: 1;
}
.activity-timeline {
  position: relative;
  padding-left: 20px;
}
.activity-timeline::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, #0ea5e9, #e2e8f0);
}
.permission-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.permission-badge.full {
  background: linear-gradient(135deg, #0ea5e9, #0284c7);
  color: white;
}
.permission-badge.limited {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}
.password-strength {
  height: 4px;
  border-radius: 2px;
  transition: all 0.3s ease;
}
.password-strength.weak { background: #ef4444; width: 33%; }
.password-strength.medium { background: #f59e0b; width: 66%; }
.password-strength.strong { background: #10b981; width: 100%; }
.product-disabled {
  opacity: 0.5;
  background: #fef2f2;
}
</style>
</head>
<body class="text-slate-800 antialiased h-screen flex overflow-hidden selection:bg-brand-100 selection:text-brand-900">
<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-gradient-to-br from-brand-900 via-slate-900 to-accent-900"></div>
  <div class="absolute inset-0 overflow-hidden">
    <div class="absolute -top-40 -right-40 w-96 h-96 bg-brand-500/20 rounded-full blur-3xl animate-float"></div>
    <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-accent-500/20 rounded-full blur-3xl animate-float" style="animation-delay: 1.5s;"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-brand-400/10 rounded-full blur-3xl animate-pulse-slow"></div>
  </div>
  <div class="login-card relative z-10 rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
    <div class="bg-gradient-to-r from-brand-600 via-brand-500 to-accent-600 px-8 py-12 text-center relative overflow-hidden">
      <div class="absolute inset-0 bg-[url('image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4xIj48Y2lyY2xlIGN4PSIzMCIgY3k9IjMwIiByPSIyIi8+PC9nPjwvZz48L3N2Zz4=')] opacity-30"></div>
      <div class="relative">
        <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg animate-float">
          <i class="fa-solid fa-cube text-5xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">EMD Inventory</h1>
        <p class="text-brand-100 text-sm font-medium">Secure Admin Portal</p>
      </div>
    </div>
    <div class="p-8">
      <div class="mb-6">
        <label class="block text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide">Select Admin User</label>
        <div class="grid grid-cols-2 gap-3">
          <button onclick="selectUser('boison')" id="user-boison" class="group p-5 rounded-2xl border-2 border-slate-200 hover:border-brand-500 hover:bg-brand-50 transition-all duration-300">
            <div class="w-14 h-14 bg-gradient-to-br from-brand-400 to-brand-600 rounded-xl mx-auto mb-3 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
              <i class="fa-solid fa-crown text-2xl text-white"></i>
            </div>
            <p class="font-bold text-slate-800 text-center">Boison</p>
            <p class="permission-badge full mt-2 w-full text-center">Main Admin</p>
          </button>
          <button onclick="selectUser('afoga')" id="user-afoga" class="group p-5 rounded-2xl border-2 border-slate-200 hover:border-amber-500 hover:bg-amber-50 transition-all duration-300">
            <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-amber-600 rounded-xl mx-auto mb-3 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
              <i class="fa-solid fa-user-shield text-2xl text-white"></i>
            </div>
            <p class="font-bold text-slate-800 text-center">Afoga</p>
            <p class="permission-badge limited mt-2 w-full text-center">Admin</p>
          </button>
        </div>
      </div>
      <div id="login-form" class="hidden space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Username</label>
          <div class="relative">
            <input type="text" id="login-username" readonly class="w-full px-4 py-3 pl-11 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-medium focus:outline-none">
            <i class="fa-solid fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Password</label>
          <div class="relative">
            <input type="password" id="login-password" placeholder="Enter password" class="w-full px-4 py-3 pl-11 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all">
            <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
        </div>
        <button onclick="login()" class="w-full py-4 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white rounded-xl font-bold shadow-lg shadow-brand-500/30 transform hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-2">
          <i class="fa-solid fa-right-to-bracket"></i>
          <span>Login to Dashboard</span>
        </button>
        <button onclick="resetLogin()" class="w-full py-3 text-slate-500 hover:text-slate-700 text-sm font-medium transition flex items-center justify-center gap-2">
          <i class="fa-solid fa-arrow-left"></i>
          <span>Back to User Selection</span>
        </button>
      </div>
    </div>
    <div class="px-8 py-4 bg-gradient-to-r from-slate-50 to-slate-100 border-t border-slate-200 text-center">
      <p class="text-xs text-slate-400 flex items-center justify-center gap-2">
        <i class="fa-solid fa-shield-halved"></i>
        <span>Secure Login</span>
      </p>
    </div>
  </div>
</div>

<!-- Welcome Modal -->
<div id="welcome-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-brand-500 to-accent-500 px-8 py-10 text-center">
        <div class="w-24 h-24 bg-white/20 backdrop-blur-md rounded-full mx-auto mb-4 flex items-center justify-center">
          <i id="welcome-icon" class="fa-solid fa-sun text-5xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-white" id="welcome-greeting">Good Morning!</h2>
        <p class="text-brand-100 text-sm mt-2">Welcome back to EMD Inventory</p>
      </div>
      <div class="p-6">
        <div class="flex items-center gap-4 mb-6">
          <img id="welcome-avatar" src="" class="w-16 h-16 rounded-full border-2 border-brand-200 object-cover">
          <div>
            <p class="font-bold text-slate-800" id="welcome-username">Boison</p>
            <p class="text-sm text-slate-500" id="welcome-role">Main Admin</p>
          </div>
        </div>
        <button onclick="closeModal('welcome-modal')" class="w-full py-3 bg-brand-600 text-white rounded-xl font-bold hover:bg-brand-700 transition">
          <i class="fa-solid fa-check mr-2"></i> Continue to Dashboard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Password Change Modal -->
<div id="password-change-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-8 py-8 text-center">
        <div class="w-20 h-20 bg-white/20 backdrop-blur-md rounded-2xl mx-auto mb-4 flex items-center justify-center">
          <i class="fa-solid fa-key text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-white">Change Password</h2>
        <p class="text-amber-100 text-sm mt-1">For security, please set a new password</p>
      </div>
      <div class="p-8 space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">New Password</label>
          <div class="relative">
            <input type="password" id="new-password" placeholder="Min 6 characters" class="w-full px-4 py-3 pl-11 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all">
            <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
          <div class="mt-2">
            <div class="password-strength" id="password-strength-bar"></div>
            <p class="text-xs text-slate-400 mt-1" id="password-strength-text">Password strength</p>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Confirm Password</label>
          <div class="relative">
            <input type="password" id="confirm-password" placeholder="Confirm new password" class="w-full px-4 py-3 pl-11 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all">
            <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
        </div>
        <button onclick="changePassword()" class="w-full py-4 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white rounded-xl font-bold shadow-lg shadow-brand-500/30 transform hover:-translate-y-0.5 transition-all">
          <i class="fa-solid fa-check mr-2"></i> Update Password
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Page Loader -->
<div id="page-loader" class="fixed inset-0 z-[99] bg-white flex flex-col items-center justify-center transition-opacity duration-300 hidden">
  <div class="loader-ring mb-4"></div>
  <h2 class="text-xl font-bold text-brand-600 tracking-wider animate-pulse">EMD INVENTORY</h2>
  <p class="text-slate-400 text-sm mt-2">Loading Dashboard...</p>
</div>

<!-- Processing Overlay -->
<div id="processing-overlay" class="fixed inset-0 z-[90] modal-backdrop hidden flex-col items-center justify-center text-white">
  <div class="loader-ring mb-4" style="filter: brightness(0) invert(1);"></div>
  <h3 class="text-xl font-semibold">Processing Request...</h3>
  <p class="text-slate-300 text-sm mt-2">Please wait while we save your data.</p>
</div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 transform -translate-x-full md:translate-x-0 flex flex-col shadow-2xl md:shadow-none">
  <div class="h-20 flex items-center px-8 border-b border-slate-100 bg-gradient-to-r from-brand-50 to-white">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-accent-600 flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
        <i class="fa-solid fa-cube text-lg"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800 leading-tight">EMD</h1>
        <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Inventory</p>
      </div>
    </div>
  </div>
  <div class="px-6 py-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
    <div class="flex items-center gap-3">
      <img id="sidebar-avatar" src="" class="w-11 h-11 rounded-full border-2 border-brand-200 shadow-sm object-cover">
      <div class="flex-1 min-w-0">
        <p class="text-sm font-bold text-slate-800 truncate" id="current-user-name">Boison</p>
        <p class="text-xs text-slate-500 truncate" id="current-user-role">Main Admin</p>
      </div>
      <button onclick="confirmLogout()" class="text-slate-400 hover:text-red-500 transition p-2 hover:bg-red-50 rounded-lg">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </div>
  <nav class="flex-1 py-6 px-4 space-y-1 overflow-y-auto">
    <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Main Menu</p>
    <a href="#" onclick="switchView('dashboard'); return false;" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-chart-pie w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Dashboard
    </a>
    <a href="#" onclick="switchView('new-order'); return false;" id="nav-new-order" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-cart-plus w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      New Order
    </a>
    <a href="#" onclick="switchView('track-orders'); return false;" id="nav-track-orders" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-truck-fast w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Track Orders
    </a>
    <a href="#" onclick="switchView('history'); return false;" id="nav-history" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-clock-rotate-left w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Order History
    </a>
    <a href="#" onclick="switchView('customers'); return false;" id="nav-customers" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-users w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Customers
    </a>
    <a href="#" onclick="switchView('daily-report'); return false;" id="nav-daily-report" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-envelope-open-text w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Daily Report
    </a>
    <a href="#" onclick="switchView('report-tracker'); return false;" id="nav-report-tracker" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-clipboard-list w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Report Tracker
    </a>
    <a href="#" onclick="switchView('activity-log'); return false;" id="nav-activity-log" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-list-check w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Activity Log
    </a>
    <a href="#" onclick="switchView('backup'); return false;" id="nav-backup" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
      <i class="fa-solid fa-database w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
      Backup & Restore
    </a>
    <div id="boison-admin-section" class="pt-6 mt-6 border-t border-slate-100 hidden">
      <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Admin Controls</p>
      <a href="#" onclick="switchView('user-management'); return false;" id="nav-user-management" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
        <i class="fa-solid fa-users-gear w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
        User Management
      </a>
      <a href="#" onclick="switchView('product-management'); return false;" id="nav-product-management" class="nav-item flex items-center px-4 py-3 text-slate-600 rounded-xl hover:bg-slate-50 transition-colors group">
        <i class="fa-solid fa-box w-6 text-center mr-3 text-slate-400 group-hover:text-brand-500 transition-colors"></i>
        Product Manager
      </a>
    </div>
  </nav>
</aside>

<div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-30 hidden md:hidden opacity-0 transition-opacity"></div>

<main class="flex-1 flex flex-col h-screen overflow-hidden relative md:ml-72 transition-all duration-300">
  <header class="h-20 glass border-b border-slate-200/60 flex items-center justify-between px-6 z-20 sticky top-0">
    <div class="flex items-center gap-4">
      <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-xl transition">
        <i class="fa-solid fa-bars text-xl"></i>
      </button>
      <div>
        <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
        <p class="text-xs text-slate-500 hidden sm:block">Overview of your inventory and sales</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="hidden md:flex flex-col items-end">
        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Accra Time (GMT)</span>
        <div id="ghana-clock" class="text-lg font-mono font-bold text-brand-600">00:00:00</div>
      </div>
      <button onclick="openProfileModal()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-brand-600 hover:border-brand-200 transition shadow-sm">
        <i class="fa-solid fa-user"></i>
      </button>
    </div>
  </header>

  <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="main-container">
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="space-y-8 animate-fade-in">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <div class="glass-card rounded-2xl p-6 relative overflow-hidden group hover:shadow-lg transition-all duration-300">
          <div class="absolute right-0 top-0 w-32 h-32 bg-brand-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-sm font-medium text-slate-500">Total Revenue</p>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="dash-total-revenue">₵0.00</h3>
                <p class="text-xs text-slate-400 mt-1" id="dash-total-revenue-usd">$0.00</p>
              </div>
              <div class="w-12 h-12 rounded-xl bg-brand-500 flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                <i class="fa-solid fa-sack-dollar text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-6 relative overflow-hidden group hover:shadow-lg transition-all duration-300">
          <div class="absolute right-0 top-0 w-32 h-32 bg-purple-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-sm font-medium text-slate-500">Total Orders</p>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="dash-total-orders">0</h3>
              </div>
              <div class="w-12 h-12 rounded-xl bg-purple-500 flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                <i class="fa-solid fa-file-invoice text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-6 relative overflow-hidden group hover:shadow-lg transition-all duration-300">
          <div class="absolute right-0 top-0 w-32 h-32 bg-orange-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-sm font-medium text-slate-500">Products Sold</p>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="dash-products-sold">0</h3>
              </div>
              <div class="w-12 h-12 rounded-xl bg-orange-500 flex items-center justify-center text-white shadow-lg shadow-orange-500/30">
                <i class="fa-solid fa-boxes-stacked text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-6 relative overflow-hidden group hover:shadow-lg transition-all duration-300">
          <div class="absolute right-0 top-0 w-32 h-32 bg-pink-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-sm font-medium text-slate-500">Avg. Order Value</p>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="dash-avg-order">₵0.00</h3>
                <p class="text-xs text-slate-400 mt-1" id="dash-avg-order-usd">$0.00</p>
              </div>
              <div class="w-12 h-12 rounded-xl bg-pink-500 flex items-center justify-center text-white shadow-lg shadow-pink-500/30">
                <i class="fa-solid fa-calculator text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-6 relative overflow-hidden group hover:shadow-lg transition-all duration-300">
          <div class="absolute right-0 top-0 w-32 h-32 bg-green-50 rounded-full -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
          <div class="relative z-10">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-sm font-medium text-slate-500">Total Products</p>
                <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-1" id="dash-total-products">0</h3>
              </div>
              <div class="w-12 h-12 rounded-xl bg-green-500 flex items-center justify-center text-white shadow-lg shadow-green-500/30">
                <i class="fa-solid fa-cubes text-xl"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass-card rounded-2xl p-6 shadow-sm">
          <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-line text-brand-500"></i> Revenue Trends
          </h3>
          <canvas id="revenue-chart" height="200"></canvas>
        </div>
        <div class="glass-card rounded-2xl p-6 shadow-sm">
          <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-accent-500"></i> Product Distribution
          </h3>
          <canvas id="product-chart" height="200"></canvas>
        </div>
      </div>

      <div id="low-stock-alerts" class="hidden glass-card rounded-2xl p-6 shadow-sm border-l-4 border-l-red-500">
        <h3 class="text-lg font-bold text-red-600 flex items-center gap-2 mb-4">
          <i class="fa-solid fa-triangle-exclamation animate-pulse"></i> Low Stock Alerts
        </h3>
        <div id="low-stock-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-bolt text-brand-500"></i> Recent Activity
          </h3>
          <button onclick="switchView('history'); return false;" class="text-sm text-brand-600 font-semibold hover:text-brand-700 hover:underline">View All</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100">
                <th class="py-3 font-semibold pl-4">Order ID</th>
                <th class="py-3 font-semibold">Customer</th>
                <th class="py-3 font-semibold">Date & Time</th>
                <th class="py-3 font-semibold">Created By</th>
                <th class="py-3 font-semibold text-right pr-4">Total</th>
                <th class="py-3 font-semibold text-center">Status</th>
              </tr>
            </thead>
            <tbody id="recent-orders-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- NEW ORDER VIEW -->
    <div id="view-new-order" class="hidden animate-fade-in h-full">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
        <div class="lg:col-span-7 space-y-6">
          <div class="glass-card rounded-2xl p-6 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-1 h-6 bg-brand-500 rounded-full"></span>
              Order Details <span class="text-red-500 text-sm">*</span> Required
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Order Date <span class="text-red-500">*</span></label>
                <input type="date" id="order-date" required class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all bg-white shadow-sm">
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Customer Name <span class="text-red-500">*</span></label>
                <input type="text" id="customer-name" required placeholder="e.g. John Doe" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all bg-white shadow-sm">
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Destination <span class="text-red-500">*</span></label>
                <input type="text" id="customer-destination" required placeholder="e.g. Accra, Osu" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all bg-white shadow-sm">
              </div>
            </div>
          </div>

          <div class="glass-card rounded-2xl p-6 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-1 h-6 bg-accent-500 rounded-full"></span>
              Add Products
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
              <div class="md:col-span-6">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Product</label>
                <div class="relative">
                  <select id="productSelect" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all appearance-none bg-white shadow-sm pr-10">
                    <option value="">Select a product...</option>
                  </select>
                  <div class="absolute right-3 top-3.5 text-slate-400 pointer-events-none">
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                  </div>
                </div>
              </div>
              <div class="md:col-span-3">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Price</label>
                <input type="text" id="product-price-display" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-500 font-medium cursor-not-allowed shadow-sm text-xs">
              </div>
              <div class="md:col-span-3">
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase tracking-wide">Qty</label>
                <input type="number" id="product-quantity" min="1" value="1" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all bg-white shadow-sm">
              </div>
            </div>
            <div class="mt-6 flex justify-end">
              <button onclick="addToOrderList()" class="bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-brand-500/30 transform hover:-translate-y-0.5 transition-all flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Add Item
              </button>
            </div>
          </div>

          <div class="glass-card rounded-2xl p-6 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span class="w-1 h-6 bg-green-500 rounded-full"></span>
              Registration Status
            </h3>
            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-xl">
              <div>
                <p class="font-semibold text-slate-800">New Customer Registration?</p>
                <p class="text-xs text-slate-500 mt-1">Adds ₵100.00 ($10.00) registration fee</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="registration-fee-toggle" onchange="updateRegistrationFee()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="lg:col-span-5">
          <div class="glass-card rounded-2xl p-6 shadow-xl sticky top-24 flex flex-col h-full max-h-[calc(100vh-8rem)] border-t-4 border-t-brand-500">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center justify-between">
              <span class="flex items-center gap-2">
                <i class="fa-solid fa-receipt text-brand-500"></i> Order Summary
              </span>
              <span id="item-count-badge" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded-md">0 Items</span>
            </h3>
            <div class="flex-1 overflow-y-auto mb-4 space-y-3 pr-2" id="order-items-container"></div>
            <div class="border-t border-slate-200 pt-4 space-y-2 bg-slate-50/50 p-4 rounded-xl">
              <div class="flex justify-between text-slate-500 text-sm">
                <span>Subtotal</span>
                <div class="text-right">
                  <div id="summary-subtotal-ghs" class="font-medium">₵0.00</div>
                  <div id="summary-subtotal-usd" class="text-xs text-slate-400">$0.00</div>
                </div>
              </div>
              <div id="registration-fee-row" class="hidden flex justify-between text-green-600 text-sm">
                <span>Registration Fee</span>
                <div class="text-right">
                  <div id="summary-reg-fee-ghs" class="font-medium">₵100.00</div>
                  <div id="summary-reg-fee-usd" class="text-xs text-green-400">$10.00</div>
                </div>
              </div>
              <div class="flex justify-between text-lg font-bold text-slate-800 pt-2 border-t border-dashed border-slate-300">
                <span>Grand Total</span>
                <div class="text-right">
                  <div id="summary-total-ghs" class="text-brand-600">₵0.00</div>
                  <div id="summary-total-usd" class="text-xs text-slate-400">$0.00</div>
                </div>
              </div>
            </div>
            <button onclick="saveOrder()" class="w-full mt-6 bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-bold shadow-xl transform hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2 group">
              <span>Confirm & Save Order</span>
              <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TRACK ORDERS VIEW -->
    <div id="view-track-orders" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-truck-fast text-brand-500"></i> Track Orders & Inventory
          </h3>
          <div class="flex gap-2">
            <button onclick="openAddProductModal()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold hover:bg-brand-600 transition flex items-center gap-2">
              <i class="fa-solid fa-plus"></i> Add New Product
            </button>
            <button onclick="checkLowStock(true)" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition flex items-center gap-2">
              <i class="fa-solid fa-bell"></i> Check Stock
            </button>
          </div>
        </div>
        <div class="overflow-x-auto mb-8">
          <h4 class="font-bold text-slate-700 mb-4">Current Inventory Levels</h4>
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                <th class="py-3 px-4 font-semibold">Product Name</th>
                <th class="py-3 px-4 font-semibold text-center">Price (GHS)</th>
                <th class="py-3 px-4 font-semibold text-center">Price (USD)</th>
                <th class="py-3 px-4 font-semibold text-center">Stock Level</th>
                <th class="py-3 px-4 font-semibold text-center">Status</th>
                <th class="py-3 px-4 font-semibold text-center">Action</th>
              </tr>
            </thead>
            <tbody id="inventory-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
        <div>
          <h4 class="font-bold text-slate-700 mb-4">All Orders Tracking</h4>
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                  <th class="py-3 px-4 font-semibold">Order ID</th>
                  <th class="py-3 px-4 font-semibold">Date & Time</th>
                  <th class="py-3 px-4 font-semibold">Customer</th>
                  <th class="py-3 px-4 font-semibold">Created By</th>
                  <th class="py-3 px-4 font-semibold">Items</th>
                  <th class="py-3 px-4 font-semibold text-right">Total</th>
                  <th class="py-3 px-4 font-semibold text-center">Status</th>
                </tr>
              </thead>
              <tbody id="track-orders-body" class="text-sm text-slate-600"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOMERS VIEW -->
    <div id="view-customers" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-users text-brand-500"></i> Customer Management
          </h3>
          <div class="flex gap-2">
            <button onclick="downloadCustomerTemplate()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition flex items-center gap-2">
              <i class="fa-solid fa-download"></i> Download Template
            </button>
            <button onclick="document.getElementById('customer-bulk-upload').click()" class="px-4 py-2 bg-accent-500 text-white rounded-lg text-sm font-semibold hover:bg-accent-600 transition flex items-center gap-2">
              <i class="fa-solid fa-upload"></i> Bulk Upload
            </button>
            <input type="file" id="customer-bulk-upload" accept=".xlsx,.xls,.csv" class="hidden" onchange="uploadCustomers(event)">
            <button onclick="openAddCustomerModal()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold hover:bg-brand-600 transition flex items-center gap-2">
              <i class="fa-solid fa-user-plus"></i> Add Customer
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                <th class="py-3 px-4 font-semibold">Name</th>
                <th class="py-3 px-4 font-semibold">Phone Number</th>
                <th class="py-3 px-4 font-semibold">Added By</th>
                <th class="py-3 px-4 font-semibold">Date Added</th>
                <th class="py-3 px-4 font-semibold text-center">Status</th>
                <th class="py-3 px-4 font-semibold text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="customers-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <h3 class="text-lg font-bold text-slate-800">Order History</h3>
          <div class="flex flex-wrap gap-3">
            <input type="date" id="filter-date-from" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
            <input type="date" id="filter-date-to" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
            <button onclick="applyDateFilter()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold">Filter</button>
            <button onclick="clearDateFilter()" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm font-semibold">Reset</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                <th class="py-3 px-4 font-semibold">ID</th>
                <th class="py-3 px-4 font-semibold">Date & Time</th>
                <th class="py-3 px-4 font-semibold">Customer</th>
                <th class="py-3 px-4 font-semibold">Destination</th>
                <th class="py-3 px-4 font-semibold">Created By</th>
                <th class="py-3 px-4 font-semibold text-right">Total</th>
                <th class="py-3 px-4 font-semibold text-center">Details</th>
              </tr>
            </thead>
            <tbody id="history-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- DAILY REPORT VIEW -->
    <div id="view-daily-report" class="hidden animate-fade-in">
      <div class="max-w-3xl mx-auto">
        <div class="glass-card rounded-2xl p-8 shadow-sm">
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fa-solid fa-envelope-open-text text-4xl text-brand-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Send Daily Report</h3>
            <p class="text-slate-500">Send a comprehensive order report to admin</p>
          </div>
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Select Admin Recipient</label>
              <div class="grid grid-cols-1 gap-4">
                <button onclick="selectReportRecipient('boison')" id="recipient-boison" class="p-4 rounded-xl border-2 border-slate-200 hover:border-brand-500 transition-all">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-brand-100 rounded-full flex items-center justify-center">
                      <i class="fa-solid fa-crown text-brand-600"></i>
                    </div>
                    <div class="text-left">
                      <p class="font-bold text-slate-800">Boison</p>
                      <p class="text-xs text-slate-500">Main Admin</p>
                    </div>
                  </div>
                </button>
              </div>
              <p class="text-xs text-slate-400 mt-2"><i class="fa-solid fa-info-circle mr-1"></i> Afoga can only send reports to Boison</p>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Admin Username</label>
              <input type="text" id="report-username" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-medium">
            </div>
            <div class="bg-slate-50 rounded-xl p-6">
              <h4 class="font-bold text-slate-800 mb-4">Report Summary</h4>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4">
                  <p class="text-xs text-slate-500">Total Orders</p>
                  <p class="text-2xl font-bold text-brand-600" id="report-total-orders">0</p>
                </div>
                <div class="bg-white rounded-lg p-4">
                  <p class="text-xs text-slate-500">Total Revenue</p>
                  <p class="text-2xl font-bold text-brand-600" id="report-total-revenue">₵0</p>
                </div>
              </div>
            </div>
            <button onclick="sendDailyReport()" class="w-full py-4 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white rounded-xl font-bold shadow-lg shadow-brand-500/30 transform hover:-translate-y-0.5 transition-all flex justify-center items-center gap-2">
              <i class="fa-solid fa-paper-plane"></i>
              <span>Send Report</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORT TRACKER VIEW (Boison Only) -->
    <div id="view-report-tracker" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
          <i class="fa-solid fa-clipboard-list text-brand-500"></i> Report Tracker
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                <th class="py-3 px-4 font-semibold">Report ID</th>
                <th class="py-3 px-4 font-semibold">Sent By</th>
                <th class="py-3 px-4 font-semibold">Sent To</th>
                <th class="py-3 px-4 font-semibold">Date & Time</th>
                <th class="py-3 px-4 font-semibold text-center">Total Orders</th>
                <th class="py-3 px-4 font-semibold text-center">Total Revenue</th>
                <th class="py-3 px-4 font-semibold text-center">Status</th>
              </tr>
            </thead>
            <tbody id="report-tracker-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ACTIVITY LOG VIEW -->
    <div id="view-activity-log" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
          <i class="fa-solid fa-list-check text-brand-500"></i> Activity Log
        </h3>
        <div class="activity-timeline space-y-4" id="activity-log-container"></div>
      </div>
    </div>

    <!-- USER MANAGEMENT VIEW (Boison Only) -->
    <div id="view-user-management" class="hidden animate-fade-in">
      <div class="max-w-4xl mx-auto space-y-6">
        <div class="glass-card rounded-2xl p-8 shadow-sm">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
              <i class="fa-solid fa-users-gear text-brand-500"></i> User Management
            </h3>
            <button onclick="openCreateUserModal()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold hover:bg-brand-600 transition flex items-center gap-2">
              <i class="fa-solid fa-user-plus"></i> Create New User
            </button>
          </div>
          <!-- Afoga User Card -->
          <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border border-amber-200 mb-4">
            <div class="flex items-center gap-6">
              <img id="user-mgmt-afoga-avatar" src="" class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h4 class="text-lg font-bold text-slate-800">Afoga</h4>
                  <span class="permission-badge limited">Admin</span>
                </div>
                <p class="text-sm text-slate-600 mb-4">Second Administrator with limited permissions</p>
                <div class="flex gap-3">
                  <button onclick="resetAfogaPassword()" class="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-semibold hover:bg-amber-600 transition">
                    <i class="fa-solid fa-key mr-1"></i> Reset Password
                  </button>
                  <button onclick="resetAfogaAvatar()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition">
                    <i class="fa-solid fa-image mr-1"></i> Reset Avatar
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Additional Users -->
          <div id="additional-users-container" class="space-y-4"></div>
        </div>
      </div>
    </div>

    <!-- PRODUCT MANAGEMENT VIEW (Boison Only) -->
    <div id="view-product-management" class="hidden animate-fade-in">
      <div class="glass-card rounded-2xl p-6 shadow-sm">
        <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
          <i class="fa-solid fa-box text-brand-500"></i> Product Manager
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="text-xs text-slate-400 uppercase border-b border-slate-100 bg-slate-50/50">
                <th class="py-3 px-4 font-semibold">Product Name</th>
                <th class="py-3 px-4 font-semibold text-center">Price (GHS)</th>
                <th class="py-3 px-4 font-semibold text-center">Price (USD)</th>
                <th class="py-3 px-4 font-semibold text-center">Stock</th>
                <th class="py-3 px-4 font-semibold text-center">Status</th>
                <th class="py-3 px-4 font-semibold text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="product-management-body" class="text-sm text-slate-600"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BACKUP & RESTORE VIEW -->
    <div id="view-backup" class="hidden animate-fade-in">
      <div class="max-w-4xl mx-auto space-y-6">
        <div class="glass-card rounded-2xl p-8 shadow-sm text-center">
          <div class="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa-solid fa-database text-3xl text-brand-600"></i>
          </div>
          <h3 class="text-2xl font-bold text-slate-800 mb-2">Backup & Restore</h3>
          <p class="text-slate-500 mb-6">Manage your order data</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
              <i class="fa-solid fa-download text-3xl text-brand-500 mb-3"></i>
              <h4 class="font-bold text-slate-800 mb-2">Export Data</h4>
              <button onclick="exportData()" class="w-full py-3 bg-brand-500 text-white rounded-xl font-bold mb-3">Download Backup</button>
              <button onclick="exportAndDelete()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">Download & Delete All</button>
            </div>
            <div class="bg-slate-50 rounded-xl p-6 border border-slate-200">
              <i class="fa-solid fa-upload text-3xl text-accent-500 mb-3"></i>
              <h4 class="font-bold text-slate-800 mb-2">Import Data</h4>
              <label class="w-full py-3 bg-accent-500 text-white rounded-xl font-bold cursor-pointer block">
                <i class="fa-solid fa-upload mr-2"></i> Upload Backup
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Add Product Modal -->
<div id="add-product-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('add-product-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-brand-500 to-accent-500 px-8 py-6 text-white">
        <h3 class="text-xl font-bold">Add New Product</h3>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Product Name</label>
          <input type="text" id="new-product-name" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Price (GHS)</label>
          <input type="number" id="new-product-price" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Initial Stock</label>
          <input type="number" id="new-product-stock" value="50" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="closeModal('add-product-modal')" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
          <button onclick="saveNewProduct()" class="flex-1 py-3 bg-brand-500 text-white rounded-xl font-bold">Add Product</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div id="add-customer-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('add-customer-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-brand-500 to-accent-500 px-8 py-6 text-white">
        <h3 class="text-xl font-bold">Add New Customer</h3>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Full Name</label>
          <input type="text" id="new-customer-name" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Phone Number (10 digits)</label>
          <input type="tel" id="new-customer-phone" maxlength="10" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500" placeholder="0XXXXXXXXX">
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="closeModal('add-customer-modal')" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
          <button onclick="saveNewCustomer()" class="flex-1 py-3 bg-brand-500 text-white rounded-xl font-bold">Add Customer</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create User Modal (Boison Only) -->
<div id="create-user-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('create-user-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-brand-500 to-accent-500 px-8 py-6 text-white">
        <h3 class="text-xl font-bold">Create New User</h3>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Username</label>
          <input type="text" id="new-user-username" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Password</label>
          <input type="password" id="new-user-password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Email</label>
          <input type="email" id="new-user-email" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div class="flex gap-3 pt-4">
          <button onclick="closeModal('create-user-modal')" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
          <button onclick="saveNewUser()" class="flex-1 py-3 bg-brand-500 text-white rounded-xl font-bold">Create User</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('profile-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-brand-600 to-accent-600 px-8 py-10 text-center relative">
        <button onclick="closeModal('profile-modal')" class="absolute top-4 right-4 text-white/70 hover:text-white transition p-2">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        <div class="avatar-upload mx-auto mb-4" id="profile-avatar-upload">
          <img id="profile-avatar" src="" class="w-32 h-32 rounded-full border-4 border-white shadow-2xl object-cover">
          <div class="overlay text-white" id="avatar-upload-overlay">
            <div class="text-center">
              <i class="fa-solid fa-camera text-2xl mb-1"></i>
              <p class="text-xs font-medium">Change Photo</p>
            </div>
          </div>
        </div>
        <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="uploadAvatar(event)">
        <h3 class="text-2xl font-bold text-white" id="profile-username">Boison</h3>
        <p class="text-brand-100 text-sm" id="profile-role">Main Admin</p>
      </div>
      <div class="p-8 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 mb-1">Email</p>
            <p class="font-semibold text-slate-800" id="profile-email">admin@emd.com</p>
          </div>
          <div class="bg-slate-50 rounded-xl p-4">
            <p class="text-xs text-slate-500 mb-1">Role</p>
            <p class="font-semibold text-slate-800" id="profile-role-detail">Main Admin</p>
          </div>
        </div>
        <div class="border-t border-slate-100 pt-6">
          <h4 class="font-bold text-slate-800 mb-4">Change Password</h4>
          <div class="space-y-3">
            <input type="password" id="profile-current-password" placeholder="Current Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
            <input type="password" id="profile-new-password" placeholder="New Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
            <button onclick="changeProfilePassword()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition">
              <i class="fa-solid fa-lock mr-2"></i> Update Password
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logout-modal" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
      <div class="bg-gradient-to-r from-red-500 to-orange-500 px-8 py-8 text-center">
        <div class="w-20 h-20 bg-white/20 backdrop-blur-md rounded-2xl mx-auto mb-4 flex items-center justify-center">
          <i class="fa-solid fa-right-from-bracket text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-white">Confirm Logout</h2>
        <p class="text-red-100 text-sm mt-1">Are you sure you want to logout?</p>
      </div>
      <div class="p-6 flex gap-3">
        <button onclick="closeModal('logout-modal')" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition">
          Cancel
        </button>
        <button onclick="logout()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition">
          <i class="fa-solid fa-right-from-bracket mr-2"></i> Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div id="order-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('order-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all scale-100 animate-slide-up">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-slate-800">Order Details</h3>
        <div class="flex items-center gap-2">
          <button onclick="downloadOrderPDF()" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-sm font-semibold hover:bg-brand-600 transition flex items-center gap-2">
            <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">PDF</span>
          </button>
          <button onclick="downloadOrderExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition flex items-center gap-2">
            <i class="fa-solid fa-file-excel"></i> <span class="hidden sm:inline">Excel</span>
          </button>
          <button onclick="closeModal('order-modal')" class="text-slate-400 hover:text-slate-600">
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <p class="text-xs text-slate-400 uppercase font-bold">Order ID</p>
            <p class="font-mono font-bold text-slate-700" id="modal-order-id">---</p>
          </div>
          <div>
            <p class="text-xs text-slate-400 uppercase font-bold">Date & Time</p>
            <p class="font-medium text-slate-700" id="modal-order-datetime">---</p>
          </div>
          <div>
            <p class="text-xs text-slate-400 uppercase font-bold">Customer</p>
            <p class="font-medium text-slate-700" id="modal-order-customer">---</p>
          </div>
          <div>
            <p class="text-xs text-slate-400 uppercase font-bold">Destination</p>
            <p class="font-medium text-slate-700" id="modal-order-destination">---</p>
          </div>
          <div>
            <p class="text-xs text-slate-400 uppercase font-bold">Created By</p>
            <p class="font-medium text-slate-700" id="modal-order-createdby">---</p>
          </div>
        </div>
        <h4 class="text-sm font-bold text-slate-800 mb-3 border-b pb-2">Items Purchased</h4>
        <div class="space-y-2 mb-6" id="modal-order-items"></div>
        <div class="bg-slate-50 p-4 rounded-xl">
          <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-slate-600">Total (GHS)</span>
            <span class="text-2xl font-bold text-brand-600" id="modal-order-total-ghs">₵0.00</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="font-bold text-slate-600">Total (USD)</span>
            <span class="text-xl font-bold text-slate-700" id="modal-order-total-usd">$0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Order Modal -->
<div id="edit-order-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity" onclick="closeModal('edit-order-modal')"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 animate-slide-up">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100">
        <h3 class="text-lg font-bold text-slate-800">Edit Order Quantity</h3>
      </div>
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-xs font-bold text-slate-500 mb-2">Product</label>
          <input type="text" id="edit-product-name" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50">
        </div>
        <div class="mb-6">
          <label class="block text-xs font-bold text-slate-500 mb-2">New Quantity</label>
          <input type="number" id="edit-quantity" min="1" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500">
        </div>
        <div class="flex gap-3">
          <button onclick="closeModal('edit-order-modal')" class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
          <button onclick="saveEditedQuantity()" class="flex-1 py-3 bg-brand-500 text-white rounded-xl font-bold">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stock Alert Modal -->
<div id="stock-alert-modal" class="fixed inset-0 z-[70] hidden">
  <div class="absolute inset-0 modal-backdrop transition-opacity"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 animate-slide-up stock-alert">
      <div class="bg-red-500 px-6 py-4 text-white text-center">
        <i class="fa-solid fa-triangle-exclamation text-4xl mb-2 animate-bounce"></i>
        <h3 class="text-xl font-bold">Low Stock Alert!</h3>
      </div>
      <div class="p-6">
        <p class="text-slate-600 mb-4">Products running low (5 or less):</p>
        <div id="stock-alert-list" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div>
        <button onclick="closeModal('stock-alert-modal')" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold">Acknowledge</button>
      </div>
    </div>
  </div>
</div>

<!-- Action Modal -->
<div id="action-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('action-modal')"></div>
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center relative z-10 transform transition-all scale-100 animate-slide-up">
    <div id="action-icon-container" class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center"></div>
    <h3 id="action-title" class="text-xl font-bold text-slate-800 mb-2">Success!</h3>
    <p id="action-message" class="text-slate-500 mb-6">Operation completed.</p>
    <button onclick="closeModal('action-modal')" class="w-full py-3 bg-brand-600 text-white rounded-xl font-bold">Continue</button>
  </div>
</div>

<script>
// Constants
const EXCHANGE_RATE = 10;
const LOW_STOCK_THRESHOLD = 5;

// State Variables
let stockAlertInterval = null;
let currentUser = null;
let currentRole = null;
let revenueChart = null;
let productChart = null;
let selectedReportRecipient = null;
let editingOrderItem = null;
let pendingUser = null;
let afogaRestockAccess = {};

// User Management
const users = {
  boison: {
    username: 'boison',
    password: 'admin123',
    role: 'main',
    permissions: ['dashboard', 'new-order', 'track-orders', 'history', 'customers', 'daily-report', 'report-tracker', 'activity-log', 'backup', 'edit-orders', 'edit-inventory', 'user-management', 'product-management'],
    avatar: null,
    email: 'boison@emd.com',
    passwordChanged: false
  },
  afoga: {
    username: 'afoga',
    password: 'user123',
    role: 'limited',
    permissions: ['dashboard', 'new-order', 'track-orders', 'history', 'customers', 'daily-report', 'activity-log'],
    avatar: null,
    email: 'afoga@emd.com',
    passwordChanged: false
  }
};

// Data Storage
let customers = JSON.parse(localStorage.getItem('emdCustomers')) || [];
let sentReports = JSON.parse(localStorage.getItem('emdReports')) || [];
let activityLog = JSON.parse(localStorage.getItem('emdActivityLog')) || [];
let allOrders = JSON.parse(localStorage.getItem('emdOrders')) || [];
let disabledProducts = JSON.parse(localStorage.getItem('emdDisabledProducts')) || [];
let currentOrderItems = [];
let currentViewOrder = null;

// Product Data
const productsData = [
  { name: "Horite eye drop", price: 160, stock: 50 },
  { name: "Behar 3 caps", price: 280, stock: 50 },
  { name: "Force 4 DS", price: 280, stock: 50 },
  { name: "Soft lax", price: 280, stock: 50 },
  { name: "Chodex 3", price: 280, stock: 50 },
  { name: "Pros X", price: 280, stock: 50 },
  { name: "Utri tone", price: 280, stock: 50 },
  { name: "Dan Jaan 10", price: 280, stock: 50 },
  { name: "Havitas", price: 300, stock: 50 },
  { name: "Pepto rest", price: 280, stock: 50 },
  { name: "Dynamic Liv Forte", price: 280, stock: 50 },
  { name: "Clean detox", price: 280, stock: 50 },
  { name: "Cushvite 3", price: 280, stock: 50 },
  { name: "Variclear", price: 280, stock: 50 },
  { name: "Vita trace", price: 280, stock: 50 },
  { name: "Vita PX", price: 300, stock: 50 },
  { name: "Ibhar juice", price: 300, stock: 50 },
  { name: "Garlic", price: 280, stock: 50 },
  { name: "Art plus", price: 300, stock: 50 },
  { name: "Calcol Juice", price: 280, stock: 50 },
  { name: "Cedarmol juice", price: 300, stock: 50 },
  { name: "Duravine juice", price: 280, stock: 50 },
  { name: "Evertulsi drop", price: 160, stock: 50 },
  { name: "Fs desire caps", price: 280, stock: 50 },
  { name: "Gourd juice", price: 300, stock: 50 },
  { name: "IQ vision caps", price: 280, stock: 50 },
  { name: "Neutri F caps", price: 280, stock: 50 },
  { name: "Noni juice", price: 280, stock: 50 },
  { name: "TC dental", price: 160, stock: 50 },
  { name: "Dynamic slim juice", price: 300, stock: 50 },
  { name: "Vile Q", price: 280, stock: 50 },
  { name: "Cabul 500 caps", price: 280, stock: 50 },
  { name: "Pain vile oil", price: 280, stock: 50 }
];

let inventory = JSON.parse(localStorage.getItem('emdInventory')) || initializeInventory();

// Initialize Functions
function initializeInventory() {
  return productsData.map(p => ({ ...p }));
}

function loadUserData() {
  const savedUsers = localStorage.getItem('emdUsers');
  if (savedUsers) {
    const parsed = JSON.parse(savedUsers);
    Object.keys(parsed).forEach(key => {
      if (users[key]) {
        users[key] = { ...users[key], ...parsed[key] };
      }
    });
  }
  const savedAfogaAccess = localStorage.getItem('emdAfogaRestockAccess');
  if (savedAfogaAccess) {
    afogaRestockAccess = JSON.parse(savedAfogaAccess);
  }
}

function saveUserData() {
  localStorage.setItem('emdUsers', JSON.stringify(users));
  localStorage.setItem('emdAfogaRestockAccess', JSON.stringify(afogaRestockAccess));
}

function logActivity(action, details) {
  const entry = {
    id: 'ACT-' + Date.now().toString().slice(-6),
    user: currentUser,
    action: action,
    details: details,
    timestamp: new Date().toISOString()
  };
  activityLog.unshift(entry);
  if (activityLog.length > 100) activityLog.pop();
  localStorage.setItem('emdActivityLog', JSON.stringify(activityLog));
}

// Alert Sound
function playAlertSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    gainNode.gain.value = 0.3;
    oscillator.start();
    setTimeout(() => oscillator.stop(), 500);
  } catch (e) {
    console.log('Audio not supported');
  }
}

// Welcome Message
function getWelcomeMessage() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) {
    return { greeting: 'Good Morning!', icon: 'fa-sun' };
  } else if (hour >= 12 && hour < 17) {
    return { greeting: 'Good Afternoon!', icon: 'fa-cloud-sun' };
  } else if (hour >= 17 && hour < 21) {
    return { greeting: 'Good Evening!', icon: 'fa-moon' };
  } else {
    return { greeting: 'Good Night!', icon: 'fa-star' };
  }
}

// Login Functions
function selectUser(username) {
  document.getElementById('user-boison').classList.remove('border-brand-500', 'bg-brand-50');
  document.getElementById('user-afoga').classList.remove('border-amber-500', 'bg-amber-50');
  if (username === 'boison') {
    document.getElementById('user-boison').classList.add('border-brand-500', 'bg-brand-50');
  } else {
    document.getElementById('user-afoga').classList.add('border-amber-500', 'bg-amber-50');
  }
  document.getElementById('login-form').classList.remove('hidden');
  document.getElementById('login-username').value = username;
  pendingUser = username;
}

function resetLogin() {
  document.getElementById('login-form').classList.add('hidden');
  document.getElementById('user-boison').classList.remove('border-brand-500', 'bg-brand-50');
  document.getElementById('user-afoga').classList.remove('border-amber-500', 'bg-amber-50');
  document.getElementById('login-password').value = '';
  pendingUser = null;
}

function login() {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  
  if (!username) {
    showActionModal('error', 'Error', 'Please select a user');
    return;
  }
  
  if (password !== users[username].password) {
    logActivity('Login Failed', `Failed login attempt for ${username}`);
    showActionModal('error', 'Login Failed', 'Incorrect password');
    return;
  }
  
  currentUser = username;
  currentRole = users[username].role;
  logActivity('Login', `${username} logged in successfully`);
  
  if (!users[username].passwordChanged) {
    document.getElementById('login-modal').classList.add('hidden');
    document.getElementById('password-change-modal').classList.remove('hidden');
    return;
  }
  
  completeLogin();
}

function completeLogin() {
  document.getElementById('login-modal').classList.add('hidden');
  document.getElementById('page-loader').classList.remove('hidden');
  
  setTimeout(() => {
    document.getElementById('page-loader').classList.add('hidden');
    
    const welcome = getWelcomeMessage();
    document.getElementById('welcome-greeting').textContent = welcome.greeting;
    document.getElementById('welcome-icon').className = `fa-solid ${welcome.icon} text-5xl text-white`;
    document.getElementById('welcome-username').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
    document.getElementById('welcome-role').textContent = currentRole === 'main' ? 'Main Admin' : 'Admin';
    
    const avatar = users[currentUser].avatar || `https://ui-avatars.com/api/?name=${currentUser}&background=${currentRole === 'main' ? '0ea5e9' : 'f59e0b'}&color=fff&size=128`;
    document.getElementById('welcome-avatar').src = avatar;
    document.getElementById('welcome-modal').classList.remove('hidden');
  }, 1000);
  
  document.getElementById('current-user-name').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
  document.getElementById('current-user-role').textContent = currentRole === 'main' ? 'Main Admin' : 'Admin';
  
  const avatar = users[currentUser].avatar || `https://ui-avatars.com/api/?name=${currentUser}&background=${currentRole === 'main' ? '0ea5e9' : 'f59e0b'}&color=fff&size=128`;
  document.getElementById('sidebar-avatar').src = avatar;
  
  if (currentRole === 'main') {
    document.getElementById('boison-admin-section').classList.remove('hidden');
    document.getElementById('nav-report-tracker').classList.remove('disabled');
  } else {
    document.getElementById('boison-admin-section').classList.add('hidden');
    document.getElementById('nav-report-tracker').classList.add('disabled');
  }
  
  updateNavPermissions();
  initProductSelect();
  updateClock();
  setInterval(updateClock, 1000);
  setDefaultDate();
  updateDashboardStats();
  renderHistory();
  renderInventory();
  renderTrackOrders();
  renderActivityLog();
  renderCustomers();
  startStockAlertChecker();
}

function changePassword() {
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  
  if (newPassword.length < 6) {
    showActionModal('error', 'Weak Password', 'Password must be at least 6 characters');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showActionModal('error', 'Password Mismatch', 'Passwords do not match');
    return;
  }
  
  users[pendingUser].password = newPassword;
  users[pendingUser].passwordChanged = true;
  saveUserData();
  logActivity('Password Change', `${pendingUser} changed their password`);
  
  document.getElementById('password-change-modal').classList.add('hidden');
  completeLogin();
}

function logout() {
  logActivity('Logout', `${currentUser} logged out`);
  currentUser = null;
  currentRole = null;
  document.getElementById('login-modal').classList.remove('hidden');
  document.getElementById('logout-modal').classList.add('hidden');
  document.getElementById('login-password').value = '';
  resetLogin();
}

function confirmLogout() {
  document.getElementById('logout-modal').classList.remove('hidden');
}

function updateNavPermissions() {
  const permissions = users[currentUser]?.permissions || [];
  ['dashboard', 'new-order', 'track-orders', 'history', 'customers', 'daily-report', 'report-tracker', 'activity-log', 'backup', 'user-management', 'product-management'].forEach(view => {
    const navItem = document.getElementById(`nav-${view}`);
    if (navItem) {
      if (!permissions.includes(view)) {
        navItem.classList.add('disabled');
      } else {
        navItem.classList.remove('disabled');
      }
    }
  });
}

function hasPermission(permission) {
  return users[currentUser]?.permissions.includes(permission) || false;
}

// Core Functions
function initProductSelect() {
  const select = document.getElementById('productSelect');
  select.innerHTML = '<option value="">Select a product...</option>';
  
  inventory.forEach(p => {
    const isDisabled = disabledProducts.includes(p.name);
    if (isDisabled && currentRole !== 'main') return;
    
    const option = document.createElement('option');
    option.value = p.name;
    option.dataset.price = p.price;
    option.dataset.stock = p.stock;
    const usd = (p.price / EXCHANGE_RATE).toFixed(2);
    option.text = `${p.name} (₵${p.price} / $${usd}) - Stock: ${p.stock}`;
    
    if (p.stock === 0) {
      option.disabled = true;
      option.text += ' [OUT OF STOCK]';
    }
    
    select.appendChild(option);
  });
  
  select.addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const price = parseInt(selectedOption.dataset.price || 0);
    const usd = (price / EXCHANGE_RATE).toFixed(2);
    document.getElementById('product-price-display').value = price ? `₵${price.toLocaleString()} / $${usd}` : '';
  });
}

function setDefaultDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('order-date').value = today;
  document.getElementById('filter-date-from').value = today;
  document.getElementById('filter-date-to').value = today;
}

function updateClock() {
  const options = { timeZone: 'Africa/Accra', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' };
  document.getElementById('ghana-clock').textContent = new Date().toLocaleTimeString('en-US', options);
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobile-overlay');
  
  if (sidebar.classList.contains('-translate-x-full')) {
    sidebar.classList.remove('-translate-x-full');
    overlay.classList.remove('hidden');
    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
  } else {
    sidebar.classList.add('-translate-x-full');
    overlay.classList.add('opacity-0');
    setTimeout(() => overlay.classList.add('hidden'), 300);
  }
}

function switchView(viewName) {
  if (!hasPermission(viewName)) {
    showActionModal('error', 'Access Denied', 'You do not have permission to access this section');
    return;
  }
  
  ['dashboard', 'new-order', 'track-orders', 'history', 'customers', 'daily-report', 'report-tracker', 'activity-log', 'backup', 'user-management', 'product-management'].forEach(v => {
    document.getElementById(`view-${v}`).classList.add('hidden');
    const navItem = document.getElementById(`nav-${v}`);
    if (navItem) navItem.classList.remove('active');
  });
  
  document.getElementById(`view-${viewName}`).classList.remove('hidden');
  const activeNav = document.getElementById(`nav-${viewName}`);
  if (activeNav) activeNav.classList.add('active');
  
  const titles = {
    'dashboard': 'Dashboard',
    'new-order': 'Create New Order',
    'track-orders': 'Track Orders & Inventory',
    'history': 'Order History',
    'customers': 'Customer Management',
    'daily-report': 'Daily Report',
    'report-tracker': 'Report Tracker',
    'activity-log': 'Activity Log',
    'backup': 'Backup & Restore',
    'user-management': 'User Management',
    'product-management': 'Product Manager'
  };
  
  document.getElementById('page-title').textContent = titles[viewName];
  
  if(window.innerWidth < 768) {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar.classList.contains('-translate-x-full')) toggleSidebar();
  }
  
  if(viewName === 'dashboard') {
    updateDashboardStats();
    checkLowStock(false);
  }
  if(viewName === 'history') renderHistory();
  if(viewName === 'track-orders') {
    renderInventory();
    renderTrackOrders();
  }
  if(viewName === 'daily-report') {
    updateReportSummary();
  }
  if(viewName === 'report-tracker') {
    renderReportTracker();
  }
  if(viewName === 'activity-log') {
    renderActivityLog();
  }
  if(viewName === 'user-management') {
    renderUserManagement();
  }
  if(viewName === 'product-management') {
    renderProductManagement();
  }
  if(viewName === 'customers') {
    renderCustomers();
  }
}

// Order Functions
function addToOrderList() {
  const select = document.getElementById('productSelect');
  const qtyInput = document.getElementById('product-quantity');
  const name = select.value;
  
  if (!name) {
    showActionModal('error', 'Error', 'Please select a product');
    return;
  }
  
  const selectedOption = select.options[select.selectedIndex];
  const price = parseInt(selectedOption.dataset.price || 0);
  const stock = parseInt(selectedOption.dataset.stock || 0);
  const qty = parseInt(qtyInput.value);
  
  if (qty > stock) {
    showActionModal('error', 'Insufficient Stock', `Only ${stock} units available`);
    return;
  }
  
  const existingItem = currentOrderItems.find(item => item.name === name);
  if (existingItem) {
    if (existingItem.qty + qty > stock) {
      showActionModal('error', 'Insufficient Stock', `Only ${stock} units available`);
      return;
    }
    existingItem.qty += qty;
    existingItem.total = existingItem.qty * existingItem.price;
  } else {
    currentOrderItems.push({ name, price, qty, total: price * qty });
  }
  
  renderOrderItems();
  select.value = "";
  document.getElementById('product-price-display').value = "";
  qtyInput.value = 1;
}

function renderOrderItems() {
  const container = document.getElementById('order-items-container');
  const badge = document.getElementById('item-count-badge');
  
  if (currentOrderItems.length === 0) {
    container.innerHTML = `
      <div class="text-center text-slate-400 py-12">
        <i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-30"></i>
        <p class="text-sm">Cart is empty</p>
      </div>`;
    badge.textContent = "0 Items";
    updateTotals(0);
    return;
  }
  
  container.innerHTML = '';
  let grandTotal = 0;
  let totalQty = 0;
  
  currentOrderItems.forEach((item, index) => {
    grandTotal += item.total;
    totalQty += item.qty;
    const usd = (item.total / EXCHANGE_RATE).toFixed(2);
    
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm';
    div.innerHTML = `
      <div class="flex-1">
        <p class="font-bold text-slate-800 text-sm">${item.name}</p>
        <p class="text-xs text-slate-500">${item.qty} x ₵${item.price} / $${(item.price/EXCHANGE_RATE).toFixed(2)}</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="font-bold text-brand-600">₵${item.total.toLocaleString()}</div>
          <div class="text-xs text-slate-400">$${usd}</div>
        </div>
        <button onclick="removeOrderItem(${index})" class="w-8 h-8 rounded-lg bg-red-50 text-red-400 hover:bg-red-100">
          <i class="fa-solid fa-trash-can text-xs"></i>
        </button>
      </div>
    `;
    container.appendChild(div);
  });
  
  badge.textContent = `${totalQty} Items`;
  updateTotals(grandTotal);
}

function removeOrderItem(index) {
  currentOrderItems.splice(index, 1);
  renderOrderItems();
}

function updateRegistrationFee() {
  renderOrderItems();
}

function updateTotals(subtotal) {
  const isRegistration = document.getElementById('registration-fee-toggle').checked;
  const regFee = isRegistration ? 100 : 0;
  const total = subtotal + regFee;
  
  document.getElementById('summary-subtotal-ghs').textContent = `₵${subtotal.toLocaleString()}`;
  document.getElementById('summary-subtotal-usd').textContent = `$${(subtotal / EXCHANGE_RATE).toFixed(2)}`;
  
  const regRow = document.getElementById('registration-fee-row');
  if (isRegistration) {
    regRow.classList.remove('hidden');
    document.getElementById('summary-reg-fee-ghs').textContent = `₵${regFee}`;
    document.getElementById('summary-reg-fee-usd').textContent = `$${(regFee / EXCHANGE_RATE).toFixed(2)}`;
  } else {
    regRow.classList.add('hidden');
  }
  
  document.getElementById('summary-total-ghs').textContent = `₵${total.toLocaleString()}`;
  document.getElementById('summary-total-usd').textContent = `$${(total / EXCHANGE_RATE).toFixed(2)}`;
}

function saveOrder() {
  if (currentOrderItems.length === 0) {
    showActionModal('error', 'Empty Order', 'Please add products');
    return;
  }
  
  const customerName = document.getElementById('customer-name').value.trim();
  const destination = document.getElementById('customer-destination').value.trim();
  const orderDate = document.getElementById('order-date').value;
  
  if (!customerName || !destination) {
    showActionModal('error', 'Missing Info', 'Please fill all required fields');
    return;
  }
  
  const isRegistration = document.getElementById('registration-fee-toggle').checked;
  const regFee = isRegistration ? 100 : 0;
  const subtotal = currentOrderItems.reduce((sum, item) => sum + item.total, 0);
  const totalAmount = subtotal + regFee;
  
  for (const item of currentOrderItems) {
    const product = inventory.find(p => p.name === item.name);
    if (!product || product.stock < item.qty) {
      showActionModal('error', 'Stock Error', `Insufficient stock for ${item.name}`);
      return;
    }
  }
  
  document.getElementById('processing-overlay').classList.remove('hidden');
  document.getElementById('processing-overlay').classList.add('flex');
  
  setTimeout(() => {
    currentOrderItems.forEach(item => {
      const product = inventory.find(p => p.name === item.name);
      if (product) {
        product.stock -= item.qty;
        if (product.stock === 0 && currentRole === 'limited') {
          afogaRestockAccess[product.name] = true;
        }
      }
    });
    
    localStorage.setItem('emdInventory', JSON.stringify(inventory));
    saveUserData();
    
    const now = new Date();
    const newOrder = {
      id: 'EMD-' + Date.now().toString().slice(-6),
      date: orderDate,
      timestamp: now.toISOString(),
      customer: customerName,
      destination: destination,
      items: [...currentOrderItems],
      registrationFee: regFee,
      subtotal: subtotal,
      total: totalAmount,
      createdBy: currentUser
    };
    
    allOrders.unshift(newOrder);
    localStorage.setItem('emdOrders', JSON.stringify(allOrders));
    
    logActivity('Order Created', `New order ${newOrder.id} created by ${currentUser}`);
    
    currentOrderItems = [];
    renderOrderItems();
    document.getElementById('customer-name').value = '';
    document.getElementById('customer-destination').value = '';
    document.getElementById('registration-fee-toggle').checked = false;
    setDefaultDate();
    initProductSelect();
    
    document.getElementById('processing-overlay').classList.add('hidden');
    document.getElementById('processing-overlay').classList.remove('flex');
    
    showActionModal('success', 'Order Saved', `Order ${newOrder.id} recorded`);
    switchView('dashboard');
  }, 1500);
}

// Dashboard Functions
function updateDashboardStats() {
  const totalOrders = allOrders.length;
  const totalRevenue = allOrders.reduce((sum, order) => sum + order.total, 0);
  const totalProducts = allOrders.reduce((sum, order) => sum + order.items.reduce((s, i) => s + i.qty, 0), 0);
  const avgOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
  const totalInventoryProducts = inventory.reduce((sum, p) => sum + p.stock, 0);
  
  animateValue("dash-total-revenue", 0, totalRevenue, 1500, true);
  document.getElementById('dash-total-revenue-usd').textContent = `$${(totalRevenue / EXCHANGE_RATE).toFixed(2)}`;
  animateValue("dash-total-orders", 0, totalOrders, 1500);
  animateValue("dash-products-sold", 0, totalProducts, 1500);
  animateValue("dash-avg-order", 0, Math.floor(avgOrder), 1500, true);
  document.getElementById('dash-avg-order-usd').textContent = `$${(avgOrder / EXCHANGE_RATE).toFixed(2)}`;
  animateValue("dash-total-products", 0, totalInventoryProducts, 1500);
  
  const tbody = document.getElementById('recent-orders-body');
  tbody.innerHTML = '';
  
  if (totalOrders === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">No recent orders</td></tr>';
  } else {
    allOrders.slice(0, 5).forEach(order => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-50 hover:bg-slate-50';
      const dateTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date;
      tr.innerHTML = `
        <td class="py-3 pl-4 font-bold text-brand-600">${order.id}</td>
        <td class="py-3">${order.customer}</td>
        <td class="py-3 text-slate-500">${dateTime}</td>
        <td class="py-3 text-slate-500 capitalize">${order.createdBy || 'Unknown'}</td>
        <td class="py-3 text-right pr-4 font-bold">₵${order.total.toLocaleString()}</td>
        <td class="py-3 text-center"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">Completed</span></td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  renderCharts();
}

function renderCharts() {
  const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
  const productCtx = document.getElementById('product-chart').getContext('2d');
  
  if (revenueChart) revenueChart.destroy();
  if (productChart) productChart.destroy();
  
  const last7Days = [];
  const revenueData = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    last7Days.push(dateStr);
    const dayRevenue = allOrders
      .filter(o => o.date === dateStr)
      .reduce((sum, o) => sum + o.total, 0);
    revenueData.push(dayRevenue);
  }
  
  revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: last7Days,
      datasets: [{
        label: 'Revenue (₵)',
         revenueData,
        borderColor: '#0ea5e9',
        backgroundColor: 'rgba(14, 165, 233, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
  
  const productSales = {};
  allOrders.forEach(order => {
    order.items.forEach(item => {
      productSales[item.name] = (productSales[item.name] || 0) + item.qty;
    });
  });
  
  const topProducts = Object.entries(productSales)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  productChart = new Chart(productCtx, {
    type: 'doughnut',
     {
      labels: topProducts.map(p => p[0]),
      datasets: [{
         topProducts.map(p => p[1]),
        backgroundColor: ['#0ea5e9', '#6366f1', '#f59e0b', '#10b981', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'right' } }
    }
  });
}

// History Functions
function renderHistory() {
  const tbody = document.getElementById('history-body');
  tbody.innerHTML = '';
  
  const fromDate = document.getElementById('filter-date-from').value;
  const toDate = document.getElementById('filter-date-to').value;
  
  const filteredOrders = allOrders.filter(order => {
    if (!fromDate && !toDate) return true;
    if (fromDate && order.date < fromDate) return false;
    if (toDate && order.date > toDate) return false;
    return true;
  });
  
  if (filteredOrders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">No orders found</td></tr>';
    return;
  }
  
  filteredOrders.forEach(order => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 hover:bg-slate-50';
    const dateTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date;
    const usd = (order.total / EXCHANGE_RATE).toFixed(2);
    tr.innerHTML = `
      <td class="py-3 px-4 font-bold text-brand-600">${order.id}</td>
      <td class="py-3 px-4 text-slate-500">${dateTime}</td>
      <td class="py-3 px-4 font-medium">${order.customer}</td>
      <td class="py-3 px-4 text-slate-500">${order.destination}</td>
      <td class="py-3 px-4 text-slate-500 capitalize">${order.createdBy || 'Unknown'}</td>
      <td class="py-3 px-4 text-right">
        <div class="font-bold">₵${order.total.toLocaleString()}</div>
        <div class="text-xs text-slate-400">$${usd}</div>
      </td>
      <td class="py-3 px-4 text-center">
        <button onclick="viewOrderDetails('${order.id}')" class="w-8 h-8 rounded-lg bg-brand-50 text-brand-600 hover:bg-brand-500 hover:text-white transition">
          <i class="fa-solid fa-eye"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function applyDateFilter() {
  renderHistory();
}

function clearDateFilter() {
  document.getElementById('filter-date-from').value = '';
  document.getElementById('filter-date-to').value = '';
  renderHistory();
}

// Track Orders & Inventory
function renderInventory() {
  const tbody = document.getElementById('inventory-body');
  tbody.innerHTML = '';
  
  inventory.forEach((product, index) => {
    const isDisabled = disabledProducts.includes(product.name);
    const tr = document.createElement('tr');
    tr.className = `border-b border-slate-100 hover:bg-slate-50 ${isDisabled ? 'product-disabled' : ''}`;
    const usd = (product.price / EXCHANGE_RATE).toFixed(2);
    
    let statusClass = 'bg-green-100 text-green-700';
    let statusText = 'In Stock';
    if (product.stock === 0) {
      statusClass = 'bg-red-100 text-red-700';
      statusText = 'Out of Stock';
    } else if (product.stock <= LOW_STOCK_THRESHOLD) {
      statusClass = 'bg-orange-100 text-orange-700';
      statusText = 'Low Stock';
    }
    
    if (isDisabled) {
      statusClass = 'bg-slate-200 text-slate-600';
      statusText = 'Disabled';
    }
    
    const canRestock = currentRole === 'main' || (currentRole === 'limited' && product.stock === 0 && afogaRestockAccess[product.name]);
    
    tr.innerHTML = `
      <td class="py-3 px-4 font-medium">${product.name}</td>
      <td class="py-3 px-4 text-center font-bold">₵${product.price}</td>
      <td class="py-3 px-4 text-center">$${usd}</td>
      <td class="py-3 px-4 text-center font-bold ${product.stock <= LOW_STOCK_THRESHOLD && !isDisabled ? 'text-red-600' : ''}">${product.stock}</td>
      <td class="py-3 px-4 text-center"><span class="${statusClass} px-3 py-1 rounded-full text-xs font-bold">${statusText}</span></td>
      <td class="py-3 px-4 text-center">
        ${canRestock && !isDisabled ? `<button onclick="restockProduct(${index})" class="w-8 h-8 rounded-lg bg-brand-50 text-brand-600 hover:bg-brand-500 hover:text-white"><i class="fa-solid fa-plus"></i></button>` : (isDisabled ? '<span class="text-slate-400 text-xs">Disabled</span>' : '<span class="text-slate-400 text-xs">No Access</span>')}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function restockProduct(index) {
  const product = inventory[index];
  const newStock = prompt(`Enter new stock for ${product.name}:`, product.stock + 50);
  
  if (newStock !== null && !isNaN(newStock) && parseInt(newStock) >= 0) {
    product.stock = parseInt(newStock);
    localStorage.setItem('emdInventory', JSON.stringify(inventory));
    
    if (currentRole === 'limited') {
      delete afogaRestockAccess[product.name];
      saveUserData();
    }
    
    renderInventory();
    initProductSelect();
    logActivity('Inventory Update', `${currentUser} restocked ${product.name} to ${product.stock} units`);
    showActionModal('success', 'Updated', `${product.name} stock updated`);
  }
}

function renderTrackOrders() {
  const tbody = document.getElementById('track-orders-body');
  tbody.innerHTML = '';
  
  allOrders.forEach(order => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 hover:bg-slate-50';
    const usd = (order.total / EXCHANGE_RATE).toFixed(2);
    const itemsCount = order.items.reduce((sum, i) => sum + i.qty, 0);
    const dateTime = order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date;
    
    tr.innerHTML = `
      <td class="py-3 px-4 font-bold text-brand-600">${order.id}</td>
      <td class="py-3 px-4 text-slate-500">${dateTime}</td>
      <td class="py-3 px-4 font-medium">${order.customer}</td>
      <td class="py-3 px-4 text-slate-500 capitalize">${order.createdBy || 'Unknown'}</td>
      <td class="py-3 px-4 text-slate-500">${itemsCount} items</td>
      <td class="py-3 px-4 text-right">
        <div class="font-bold">₵${order.total.toLocaleString()}</div>
        <div class="text-xs text-slate-400">$${usd}</div>
      </td>
      <td class="py-3 px-4 text-center"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">Completed</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// Customer Management
function renderCustomers() {
  const tbody = document.getElementById('customers-body');
  tbody.innerHTML = '';
  
  if (customers.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">No customers found</td></tr>';
    return;
  }
  
  customers.forEach((customer, index) => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 hover:bg-slate-50';
    const dateAdded = customer.dateAdded ? new Date(customer.dateAdded).toLocaleDateString() : 'N/A';
    
    tr.innerHTML = `
      <td class="py-3 px-4 font-medium">${customer.name}</td>
      <td class="py-3 px-4 text-slate-600">${customer.phone}</td>
      <td class="py-3 px-4 text-slate-500 capitalize">${customer.addedBy || 'Unknown'}</td>
      <td class="py-3 px-4 text-slate-500">${dateAdded}</td>
      <td class="py-3 px-4 text-center"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">Active</span></td>
      <td class="py-3 px-4 text-center">
        ${currentRole === 'main' ? `<button onclick="deleteCustomer(${index})" class="w-7 h-7 rounded bg-red-100 text-red-600 hover:bg-red-500 hover:text-white"><i class="fa-solid fa-trash text-xs"></i></button>` : '<span class="text-slate-400 text-xs">No Access</span>'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openAddCustomerModal() {
  document.getElementById('new-customer-name').value = '';
  document.getElementById('new-customer-phone').value = '';
  openModal('add-customer-modal');
}

function saveNewCustomer() {
  const name = document.getElementById('new-customer-name').value.trim();
  const phone = document.getElementById('new-customer-phone').value.trim();
  
  if (!name) {
    showActionModal('error', 'Error', 'Customer name is required');
    return;
  }
  
  if (!/^\d{10}$/.test(phone)) {
    showActionModal('error', 'Invalid Phone', 'Phone number must be exactly 10 digits');
    return;
  }
  
  customers.push({
    name,
    phone,
    addedBy: currentUser,
    dateAdded: new Date().toISOString()
  });
  
  localStorage.setItem('emdCustomers', JSON.stringify(customers));
  logActivity('Customer Added', `${currentUser} added customer ${name}`);
  
  closeModal('add-customer-modal');
  renderCustomers();
  showActionModal('success', 'Customer Added', `${name} has been added successfully`);
}

function deleteCustomer(index) {
  if (!confirm('Are you sure you want to delete this customer?')) return;
  
  const customer = customers[index];
  customers.splice(index, 1);
  localStorage.setItem('emdCustomers', JSON.stringify(customers));
  logActivity('Customer Deleted', `${currentUser} deleted customer ${customer.name}`);
  renderCustomers();
  showActionModal('success', 'Deleted', 'Customer deleted successfully');
}

function downloadCustomerTemplate() {
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ['Name', 'Phone Number (10 digits)'],
    ['John Doe', '0244123456'],
    ['Jane Smith', '0501234567']
  ];
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, 'Template');
  XLSX.writeFile(wb, 'Customer_Template.xlsx');
}

function uploadCustomers(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      
      let added = 0;
      let skipped = 0;
      
      json.forEach(row => {
        if (row['Name'] && /^\d{10}$/.test(String(row['Phone Number (10 digits)'] || row['Phone']))) {
          customers.push({
            name: row['Name'],
            phone: String(row['Phone Number (10 digits)'] || row['Phone']),
            addedBy: currentUser,
            dateAdded: new Date().toISOString()
          });
          added++;
        } else {
          skipped++;
        }
      });
      
      localStorage.setItem('emdCustomers', JSON.stringify(customers));
      logActivity('Bulk Customer Upload', `${currentUser} uploaded ${added} customers`);
      renderCustomers();
      showActionModal('success', 'Upload Complete', `${added} customers added, ${skipped} skipped`);
    } catch (error) {
      showActionModal('error', 'Upload Failed', 'Invalid file format');
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

// Daily Report
function selectReportRecipient(username) {
  selectedReportRecipient = username;
  document.getElementById('recipient-boison').classList.remove('border-brand-500', 'bg-brand-50');
  document.getElementById(`recipient-${username}`).classList.add('border-brand-500', 'bg-brand-50');
  document.getElementById('report-username').value = username;
}

function updateReportSummary() {
  document.getElementById('report-total-orders').textContent = allOrders.length;
  const totalRevenue = allOrders.reduce((sum, o) => sum + o.total, 0);
  document.getElementById('report-total-revenue').textContent = `₵${totalRevenue.toLocaleString()}`;
}

function sendDailyReport() {
  if (!selectedReportRecipient) {
    showActionModal('error', 'Error', 'Please select a recipient');
    return;
  }
  
  if (currentRole === 'limited' && selectedReportRecipient !== 'boison') {
    showActionModal('error', 'Access Denied', 'Afoga can only send reports to Boison');
    return;
  }
  
  document.getElementById('processing-overlay').classList.remove('hidden');
  document.getElementById('processing-overlay').classList.add('flex');
  
  setTimeout(() => {
    const report = {
      id: 'RPT-' + Date.now().toString().slice(-6),
      sentBy: currentUser,
      sentTo: selectedReportRecipient,
      timestamp: new Date().toISOString(),
      totalOrders: allOrders.length,
      totalRevenue: allOrders.reduce((sum, o) => sum + o.total, 0)
    };
    
    sentReports.unshift(report);
    localStorage.setItem('emdReports', JSON.stringify(sentReports));
    logActivity('Report Sent', `${currentUser} sent daily report to ${selectedReportRecipient}`);
    
    document.getElementById('processing-overlay').classList.add('hidden');
    document.getElementById('processing-overlay').classList.remove('flex');
    showActionModal('success', 'Report Sent', `Daily report sent to ${selectedReportRecipient}`);
  }, 2000);
}

// Report Tracker
function renderReportTracker() {
  const tbody = document.getElementById('report-tracker-body');
  tbody.innerHTML = '';
  
  if (sentReports.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">No reports sent yet</td></tr>';
    return;
  }
  
  sentReports.forEach(report => {
    const tr = document.createElement('tr');
    tr.className = 'border-b border-slate-100 hover:bg-slate-50';
    const dateTime = new Date(report.timestamp).toLocaleString();
    
    tr.innerHTML = `
      <td class="py-3 px-4 font-bold text-brand-600">${report.id}</td>
      <td class="py-3 px-4 capitalize">${report.sentBy}</td>
      <td class="py-3 px-4 capitalize">${report.sentTo}</td>
      <td class="py-3 px-4 text-slate-500">${dateTime}</td>
      <td class="py-3 px-4 text-center font-bold">${report.totalOrders}</td>
      <td class="py-3 px-4 text-center font-bold">₵${report.totalRevenue.toLocaleString()}</td>
      <td class="py-3 px-4 text-center"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">Delivered</span></td>
    `;
    tbody.appendChild(tr);
  });
}

// Activity Log
function renderActivityLog() {
  const container = document.getElementById('activity-log-container');
  container.innerHTML = '';
  
  if (activityLog.length === 0) {
    container.innerHTML = '<p class="text-slate-400 text-center py-8">No activity recorded</p>';
    return;
  }
  
  activityLog.slice(0, 50).forEach(entry => {
    const date = new Date(entry.timestamp);
    const div = document.createElement('div');
    div.className = 'relative pl-6 pb-6';
    div.innerHTML = `
      <div class="absolute left-[-21px] top-0 w-3 h-3 rounded-full bg-brand-500 border-2 border-white shadow"></div>
      <div class="bg-slate-50 rounded-xl p-4">
        <div class="flex justify-between items-start mb-2">
          <p class="font-bold text-slate-800">${entry.action}</p>
          <span class="text-xs text-slate-400">${date.toLocaleString()}</span>
        </div>
        <p class="text-sm text-slate-600">${entry.details}</p>
        <p class="text-xs text-slate-400 mt-2">By: ${entry.user}</p>
      </div>
    `;
    container.appendChild(div);
  });
}

// User Management
function renderUserManagement() {
  const avatar = users.afoga.avatar || 'https://ui-avatars.com/api/?name=afoga&background=f59e0b&color=fff&size=128';
  document.getElementById('user-mgmt-afoga-avatar').src = avatar;
  
  const container = document.getElementById('additional-users-container');
  container.innerHTML = '';
  
  Object.keys(users).forEach(username => {
    if (username !== 'boison' && username !== 'afoga') {
      const user = users[username];
      const userAvatar = user.avatar || `https://ui-avatars.com/api/?name=${username}&background=6366f1&color=fff&size=128`;
      
      const div = document.createElement('div');
      div.className = 'bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl p-6 border border-indigo-200';
      div.innerHTML = `
        <div class="flex items-center gap-6">
          <img src="${userAvatar}" class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover">
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
              <h4 class="text-lg font-bold text-slate-800">${username.charAt(0).toUpperCase() + username.slice(1)}</h4>
              <span class="permission-badge limited">Admin</span>
            </div>
            <p class="text-sm text-slate-600 mb-4">${user.email}</p>
            <div class="flex gap-3">
              <button onclick="resetUserPassword('${username}')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">
                <i class="fa-solid fa-key mr-1"></i> Reset Password
              </button>
              <button onclick="resetUserAvatar('${username}')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-300 transition">
                <i class="fa-solid fa-image mr-1"></i> Reset Avatar
              </button>
              <button onclick="deleteUser('${username}')" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                <i class="fa-solid fa-trash mr-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(div);
    }
  });
}

function openCreateUserModal() {
  document.getElementById('new-user-username').value = '';
  document.getElementById('new-user-password').value = '';
  document.getElementById('new-user-email').value = '';
  openModal('create-user-modal');
}

function saveNewUser() {
  const username = document.getElementById('new-user-username').value.trim().toLowerCase();
  const password = document.getElementById('new-user-password').value;
  const email = document.getElementById('new-user-email').value.trim();
  
  if (!username || !password || !email) {
    showActionModal('error', 'Error', 'All fields are required');
    return;
  }
  
  if (users[username]) {
    showActionModal('error', 'Error', 'Username already exists');
    return;
  }
  
  users[username] = {
    username,
    password,
    role: 'limited',
    permissions: ['dashboard', 'new-order', 'track-orders', 'history', 'customers', 'daily-report', 'activity-log'],
    avatar: null,
    email,
    passwordChanged: false
  };
  
  saveUserData();
  logActivity('User Created', `${currentUser} created new user ${username}`);
  closeModal('create-user-modal');
  renderUserManagement();
  showActionModal('success', 'User Created', `${username} has been created successfully`);
}

function resetUserPassword(username) {
  if (!confirm(`Reset ${username} password to default (user123)?`)) return;
  users[username].password = 'user123';
  users[username].passwordChanged = false;
  saveUserData();
  logActivity('Password Reset', `${currentUser} reset ${username}'s password`);
  showActionModal('success', 'Password Reset', `${username} password has been reset to default`);
}

function resetUserAvatar(username) {
  if (!confirm(`Reset ${username} avatar to default?`)) return;
  users[username].avatar = null;
  saveUserData();
  logActivity('Avatar Reset', `${currentUser} reset ${username}'s avatar`);
  renderUserManagement();
  showActionModal('success', 'Avatar Reset', `${username} avatar has been reset`);
}

function deleteUser(username) {
  if (!confirm(`Delete user ${username}? This cannot be undone.`)) return;
  delete users[username];
  saveUserData();
  logActivity('User Deleted', `${currentUser} deleted user ${username}`);
  renderUserManagement();
  showActionModal('success', 'User Deleted', `${username} has been deleted`);
}

function resetAfogaPassword() {
  if (!confirm('Reset Afoga password to default (user123)?')) return;
  users.afoga.password = 'user123';
  users.afoga.passwordChanged = false;
  saveUserData();
  logActivity('Password Reset', `${currentUser} reset Afoga's password`);
  showActionModal('success', 'Password Reset', 'Afoga password has been reset to default');
}

function resetAfogaAvatar() {
  if (!confirm('Reset Afoga avatar to default?')) return;
  users.afoga.avatar = null;
  saveUserData();
  logActivity('Avatar Reset', `${currentUser} reset Afoga's avatar`);
  renderUserManagement();
  showActionModal('success', 'Avatar Reset', 'Afoga avatar has been reset');
}

// Product Management
function renderProductManagement() {
  const tbody = document.getElementById('product-management-body');
  tbody.innerHTML = '';
  
  inventory.forEach((product, index) => {
    const isDisabled = disabledProducts.includes(product.name);
    const tr = document.createElement('tr');
    tr.className = `border-b border-slate-100 hover:bg-slate-50 ${isDisabled ? 'product-disabled' : ''}`;
    const usd = (product.price / EXCHANGE_RATE).toFixed(2);
    
    tr.innerHTML = `
      <td class="py-3 px-4 font-medium">${product.name}</td>
      <td class="py-3 px-4 text-center font-bold">₵${product.price}</td>
      <td class="py-3 px-4 text-center">$${usd}</td>
      <td class="py-3 px-4 text-center font-bold">${product.stock}</td>
      <td class="py-3 px-4 text-center"><span class="${isDisabled ? 'bg-slate-200 text-slate-600' : 'bg-green-100 text-green-700'} px-3 py-1 rounded-full text-xs font-bold">${isDisabled ? 'Disabled' : 'Active'}</span></td>
      <td class="py-3 px-4 text-center">
        <button onclick="toggleProductDisable(${index})" class="w-8 h-8 rounded-lg ${isDisabled ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} hover:opacity-80">
          <i class="fa-solid ${isDisabled ? 'fa-check' : 'fa-ban'}"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function openAddProductModal() {
  document.getElementById('new-product-name').value = '';
  document.getElementById('new-product-price').value = '';
  document.getElementById('new-product-stock').value = '50';
  openModal('add-product-modal');
}

function saveNewProduct() {
  const name = document.getElementById('new-product-name').value.trim();
  const price = parseInt(document.getElementById('new-product-price').value);
  const stock = parseInt(document.getElementById('new-product-stock').value);
  
  if (!name || !price || !stock) {
    showActionModal('error', 'Error', 'All fields are required');
    return;
  }
  
  inventory.push({ name, price, stock });
  localStorage.setItem('emdInventory', JSON.stringify(inventory));
  logActivity('Product Added', `${currentUser} added new product ${name}`);
  
  closeModal('add-product-modal');
  renderInventory();
  renderProductManagement();
  initProductSelect();
  showActionModal('success', 'Product Added', `${name} has been added successfully`);
}

function toggleProductDisable(index) {
  const product = inventory[index];
  const isDisabled = disabledProducts.includes(product.name);
  
  if (isDisabled) {
    disabledProducts = disabledProducts.filter(p => p !== product.name);
    logActivity('Product Enabled', `${currentUser} enabled product ${product.name}`);
  } else {
    disabledProducts.push(product.name);
    logActivity('Product Disabled', `${currentUser} disabled product ${product.name}`);
  }
  
  localStorage.setItem('emdDisabledProducts', JSON.stringify(disabledProducts));
  renderProductManagement();
  renderInventory();
  initProductSelect();
  showActionModal('success', 'Updated', `${product.name} ${isDisabled ? 'enabled' : 'disabled'} successfully`);
}

// Edit Order Functions
function viewOrderDetails(orderId) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return;
  
  currentViewOrder = order;
  
  document.getElementById('modal-order-id').textContent = order.id;
  document.getElementById('modal-order-datetime').textContent = order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date;
  document.getElementById('modal-order-customer').textContent = order.customer;
  document.getElementById('modal-order-destination').textContent = order.destination;
  document.getElementById('modal-order-createdby').textContent = order.createdBy ? order.createdBy.charAt(0).toUpperCase() + order.createdBy.slice(1) : 'Unknown';
  document.getElementById('modal-order-total-ghs').textContent = `₵${order.total.toLocaleString()}`;
  document.getElementById('modal-order-total-usd').textContent = `$${(order.total / EXCHANGE_RATE).toFixed(2)}`;
  
  const itemsContainer = document.getElementById('modal-order-items');
  itemsContainer.innerHTML = '';
  
  order.items.forEach((item, index) => {
    const div = document.createElement('div');
    const canEdit = hasPermission('edit-orders');
    const canEditQty = canEdit && (item.qty <= LOW_STOCK_THRESHOLD || currentRole === 'main');
    
    div.className = 'flex justify-between items-center py-2 border-b border-slate-50';
    div.innerHTML = `
      <div>
        <p class="font-medium">${item.name}</p>
        <p class="text-xs text-slate-500">Qty: ${item.qty} x ₵${item.price} / $${(item.price/EXCHANGE_RATE).toFixed(2)}</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-right">
          <div class="font-bold">₵${item.total.toLocaleString()}</div>
          <div class="text-xs text-slate-400">$${(item.total/EXCHANGE_RATE).toFixed(2)}</div>
        </div>
        ${canEditQty ? `<button onclick="openEditModal('${order.id}', ${index})" class="w-7 h-7 rounded bg-brand-100 text-brand-600 hover:bg-brand-500 hover:text-white"><i class="fa-solid fa-pen text-xs"></i></button>` : ''}
      </div>
    `;
    itemsContainer.appendChild(div);
  });
  
  if (order.registrationFee > 0) {
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center py-2 bg-green-50 px-2 rounded mt-2';
    div.innerHTML = `<span class="text-sm font-medium text-green-700">Registration Fee</span><span class="font-bold text-green-700">₵${order.registrationFee} / $${(order.registrationFee/EXCHANGE_RATE).toFixed(2)}</span>`;
    itemsContainer.appendChild(div);
  }
  
  openModal('order-modal');
}

function openEditModal(orderId, itemIndex) {
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return;
  
  editingOrderItem = { orderId, itemIndex };
  const item = order.items[itemIndex];
  
  document.getElementById('edit-product-name').value = item.name;
  document.getElementById('edit-quantity').value = item.qty;
  openModal('edit-order-modal');
}

function saveEditedQuantity() {
  if (!editingOrderItem) return;
  
  const newQty = parseInt(document.getElementById('edit-quantity').value);
  
  if (!newQty || newQty < 1) {
    showActionModal('error', 'Error', 'Invalid quantity');
    return;
  }
  
  const order = allOrders.find(o => o.id === editingOrderItem.orderId);
  const item = order.items[editingOrderItem.itemIndex];
  const product = inventory.find(p => p.name === item.name);
  
  if (newQty > item.qty) {
    const diff = newQty - item.qty;
    if (product.stock < diff) {
      showActionModal('error', 'Insufficient Stock', `Only ${product.stock} units available`);
      return;
    }
    product.stock -= diff;
  } else if (newQty < item.qty) {
    const diff = item.qty - newQty;
    product.stock += diff;
  }
  
  const oldTotal = item.total;
  item.qty = newQty;
  item.total = newQty * item.price;
  order.total = order.total - oldTotal + item.total;
  
  localStorage.setItem('emdOrders', JSON.stringify(allOrders));
  localStorage.setItem('emdInventory', JSON.stringify(inventory));
  logActivity('Order Edited', `${currentUser} edited quantity for ${item.name} in order ${order.id}`);
  
  closeModal('edit-order-modal');
  viewOrderDetails(editingOrderItem.orderId);
  renderHistory();
  renderInventory();
  initProductSelect();
  showActionModal('success', 'Updated', 'Order quantity updated successfully');
}

// Download PDF
function downloadOrderPDF() {
  if (!currentViewOrder) return;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const order = currentViewOrder;
  
  doc.setFillColor(14, 165, 233);
  doc.rect(0, 0, 210, 40, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(22);
  doc.text('EMD INVENTORY', 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.text('Order Receipt', 105, 30, { align: 'center' });
  
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(10);
  doc.text(`Order ID: ${order.id}`, 14, 50);
  doc.text(`Date: ${order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date}`, 14, 56);
  doc.text(`Customer: ${order.customer}`, 14, 62);
  doc.text(`Destination: ${order.destination}`, 14, 68);
  doc.text(`Created By: ${order.createdBy || 'Unknown'}`, 14, 74);
  
  const tableData = order.items.map(item => [
    item.name,
    item.qty.toString(),
    `₵${item.price} / $${(item.price/EXCHANGE_RATE).toFixed(2)}`,
    `₵${item.total.toLocaleString()} / $${(item.total/EXCHANGE_RATE).toFixed(2)}`
  ]);
  
  doc.autoTable({
    startY: 80,
    head: [['Product', 'Qty', 'Unit Price (GHS/USD)', 'Total (GHS/USD)']],
    body: tableData,
    theme: 'striped',
    headStyles: { fillColor: [14, 165, 233] },
  });
  
  let finalY = doc.lastAutoTable.finalY + 10;
  
  if (order.registrationFee > 0) {
    doc.text('Registration Fee:', 14, finalY);
    doc.text(`₵${order.registrationFee} / $${(order.registrationFee/EXCHANGE_RATE).toFixed(2)}`, 150, finalY, { align: 'right' });
    finalY += 10;
  }
  
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('Grand Total:', 14, finalY);
  doc.text(`₵${order.total.toLocaleString()} / $${(order.total/EXCHANGE_RATE).toFixed(2)}`, 150, finalY, { align: 'right' });
  
  doc.save(`Order_${order.id}.pdf`);
}

// Download Excel
function downloadOrderExcel() {
  if (!currentViewOrder) return;
  
  const order = currentViewOrder;
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ['Order Details'],
    ['Order ID', order.id],
    ['Date', order.timestamp ? new Date(order.timestamp).toLocaleString() : order.date],
    ['Customer', order.customer],
    ['Destination', order.destination],
    ['Created By', order.createdBy || 'Unknown'],
    [],
    ['Items'],
    ['Product Name', 'Quantity', 'Unit Price (GHS)', 'Unit Price (USD)', 'Total (GHS)', 'Total (USD)']
  ];
  
  order.items.forEach(item => {
    ws_data.push([
      item.name,
      item.qty,
      item.price,
      (item.price/EXCHANGE_RATE).toFixed(2),
      item.total,
      (item.total/EXCHANGE_RATE).toFixed(2)
    ]);
  });
  
  if (order.registrationFee > 0) {
    ws_data.push([]);
    ws_data.push(['Registration Fee', '', '', '', order.registrationFee, (order.registrationFee/EXCHANGE_RATE).toFixed(2)]);
  }
  
  ws_data.push([]);
  ws_data.push(['GRAND TOTAL', '', '', '', order.total, (order.total/EXCHANGE_RATE).toFixed(2)]);
  
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, 'Order Details');
  XLSX.writeFile(wb, `Order_${order.id}.xlsx`);
}

// Stock Alerts
function checkLowStock(auto = false) {
  const lowStockProducts = inventory.filter(p => p.stock <= LOW_STOCK_THRESHOLD && !disabledProducts.includes(p.name));
  
  if (lowStockProducts.length > 0) {
    document.getElementById('low-stock-alerts').classList.remove('hidden');
    const listContainer = document.getElementById('low-stock-container');
    listContainer.innerHTML = '';
    
    lowStockProducts.forEach(product => {
      const div = document.createElement('div');
      div.className = 'bg-red-50 border border-red-200 rounded-xl p-4 flex justify-between items-center';
      div.innerHTML = `
        <div>
          <p class="font-bold text-red-700">${product.name}</p>
          <p class="text-sm text-red-600">Only ${product.stock} left</p>
        </div>
        ${hasPermission('edit-inventory') ? `<button onclick="restockProductByName('${product.name}')" class="px-3 py-2 bg-red-500 text-white rounded-lg text-xs font-bold">Restock</button>` : ''}
      `;
      listContainer.appendChild(div);
    });
    
    if (auto) {
      playAlertSound();
      const modalList = document.getElementById('stock-alert-list');
      modalList.innerHTML = '';
      
      lowStockProducts.forEach(product => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-red-50 p-3 rounded-lg';
        div.innerHTML = `<span class="font-medium text-red-700">${product.name}</span><span class="font-bold text-red-600">${product.stock} left</span>`;
        modalList.appendChild(div);
      });
      
      openModal('stock-alert-modal');
    }
  } else {
    document.getElementById('low-stock-alerts').classList.add('hidden');
  }
}

function restockProductByName(name) {
  const index = inventory.findIndex(p => p.name === name);
  if (index !== -1) restockProduct(index);
}

function startStockAlertChecker() {
  if (stockAlertInterval) clearInterval(stockAlertInterval);
  stockAlertInterval = setInterval(() => {
    checkLowStock(true);
  }, 10000);
}

// Backup Functions
function exportData() {
  const backupData = { 
    orders: allOrders, 
    inventory, 
    users, 
    activityLog, 
    customers, 
    sentReports, 
    disabledProducts, 
    exportDate: new Date().toISOString() 
  };
  const dataStr = JSON.stringify(backupData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `EMD_Backup_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  logActivity('Backup Exported', `${currentUser} exported system backup`);
  showActionModal('success', 'Exported', 'Backup downloaded');
}

function exportAndDelete() {
  if(confirm('WARNING: This will delete all data after download. Continue?')) {
    exportData();
    setTimeout(() => {
      localStorage.removeItem('emdOrders');
      localStorage.removeItem('emdInventory');
      allOrders = [];
      inventory = initializeInventory();
      localStorage.setItem('emdInventory', JSON.stringify(inventory));
      logActivity('Data Cleared', `${currentUser} exported and deleted all data`);
      updateDashboardStats();
      renderInventory();
      showActionModal('success', 'Cleared', 'Data deleted');
    }, 1000);
  }
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      if (!importedData.orders || !importedData.inventory) throw new Error('Invalid format');
      
      if(confirm(`Import ${importedData.orders.length} orders?`)) {
        allOrders = importedData.orders;
        inventory = importedData.inventory;
        
        if (importedData.users) {
          Object.keys(importedData.users).forEach(key => {
            if (users[key]) users[key] = importedData.users[key];
          });
        }
        if (importedData.activityLog) activityLog = importedData.activityLog;
        if (importedData.customers) customers = importedData.customers;
        if (importedData.sentReports) sentReports = importedData.sentReports;
        if (importedData.disabledProducts) disabledProducts = importedData.disabledProducts;
        
        localStorage.setItem('emdOrders', JSON.stringify(allOrders));
        localStorage.setItem('emdInventory', JSON.stringify(inventory));
        localStorage.setItem('emdUsers', JSON.stringify(users));
        localStorage.setItem('emdActivityLog', JSON.stringify(activityLog));
        localStorage.setItem('emdCustomers', JSON.stringify(customers));
        localStorage.setItem('emdReports', JSON.stringify(sentReports));
        localStorage.setItem('emdDisabledProducts', JSON.stringify(disabledProducts));
        
        logActivity('Data Imported', `${currentUser} imported system backup`);
        updateDashboardStats();
        renderInventory();
        initProductSelect();
        renderCustomers();
        showActionModal('success', 'Imported', 'Data restored');
      }
    } catch (error) {
      showActionModal('error', 'Import Failed', 'Invalid backup file');
    }
  };
  reader.readAsText(file);
}

// Profile Functions
function openProfileModal() {
  const user = users[currentUser];
  document.getElementById('profile-username').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
  document.getElementById('profile-role').textContent = currentRole === 'main' ? 'Main Admin' : 'Admin';
  document.getElementById('profile-role-detail').textContent = currentRole === 'main' ? 'Main Admin' : 'Admin';
  document.getElementById('profile-email').textContent = user.email;
  
  const avatar = user.avatar || `https://ui-avatars.com/api/?name=${currentUser}&background=${currentRole === 'main' ? '0ea5e9' : 'f59e0b'}&color=fff&size=128`;
  document.getElementById('profile-avatar').src = avatar;
  
  const uploadOverlay = document.getElementById('avatar-upload-overlay');
  const uploadElement = document.getElementById('profile-avatar-upload');
  
  if (currentRole === 'limited') {
    uploadOverlay.style.display = 'none';
    uploadElement.style.cursor = 'default';
  } else {
    uploadOverlay.style.display = 'flex';
    uploadElement.style.cursor = 'pointer';
  }
  
  openModal('profile-modal');
}

function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    users[currentUser].avatar = e.target.result;
    saveUserData();
    document.getElementById('profile-avatar').src = e.target.result;
    document.getElementById('sidebar-avatar').src = e.target.result;
    logActivity('Avatar Updated', `${currentUser} updated their profile avatar`);
    showActionModal('success', 'Avatar Updated', 'Profile picture changed successfully');
  };
  reader.readAsDataURL(file);
}

function changeProfilePassword() {
  const currentPassword = document.getElementById('profile-current-password').value;
  const newPassword = document.getElementById('profile-new-password').value;
  
  if (currentPassword !== users[currentUser].password) {
    showActionModal('error', 'Wrong Password', 'Current password is incorrect');
    return;
  }
  
  if (newPassword.length < 6) {
    showActionModal('error', 'Weak Password', 'Password must be at least 6 characters');
    return;
  }
  
  users[currentUser].password = newPassword;
  saveUserData();
  logActivity('Password Changed', `${currentUser} changed their password`);
  
  document.getElementById('profile-current-password').value = '';
  document.getElementById('profile-new-password').value = '';
  closeModal('profile-modal');
  showActionModal('success', 'Password Updated', 'Password changed successfully');
}

// Modal Functions
function openModal(id) {
  document.getElementById(id).classList.remove('hidden');
}

function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}

function showActionModal(type, title, message) {
  const iconContainer = document.getElementById('action-icon-container');
  document.getElementById('action-title').textContent = title;
  document.getElementById('action-message').textContent = message;
  
  if (type === 'success') {
    iconContainer.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-100 text-green-600';
    iconContainer.innerHTML = '<i class="fa-solid fa-check text-2xl"></i>';
  } else {
    iconContainer.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-red-100 text-red-600';
    iconContainer.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-2xl"></i>';
  }
  
  openModal('action-modal');
}

function animateValue(id, start, end, duration, isCurrency = false) {
  const obj = document.getElementById(id);
  let startTimestamp = null;
  
  const step = (timestamp) => {
    if (!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    const easeProgress = 1 - Math.pow(1 - progress, 4);
    const value = Math.floor(easeProgress * (end - start) + start);
    obj.innerHTML = isCurrency ? "₵" + value.toLocaleString() : value.toLocaleString();
    if (progress < 1) window.requestAnimationFrame(step);
  };
  
  window.requestAnimationFrame(step);
}

// Password Strength Checker
document.getElementById('new-password')?.addEventListener('input', function(e) {
  const password = e.target.value;
  const strengthBar = document.getElementById('password-strength-bar');
  const strengthText = document.getElementById('password-strength-text');
  
  let strength = 'weak';
  let text = 'Weak';
  
  if (password.length >= 8 && /[A-Z]/.test(password) && /[0-9]/.test(password)) {
    strength = 'strong';
    text = 'Strong';
  } else if (password.length >= 6) {
    strength = 'medium';
    text = 'Medium';
  }
  
  strengthBar.className = `password-strength ${strength}`;
  strengthText.textContent = `Password strength: ${text}`;
});

// Initialize Application
loadUserData();

window.addEventListener('beforeunload', () => {
  if (stockAlertInterval) clearInterval(stockAlertInterval);
});
</script>
</body>
</html>

